# Context
Filename: ss-to-singbox-converter.md
Created On: 2024-12-28
Created By: Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
创建一个 shell 脚本，用于将 SS (Shadowsocks) 订阅链接转换为 sing-box outbound 的 JSON 格式。

用户提供的 SS 链接示例:
```
ss://YWVzLTEyOC1nY206d296aGlhaTA=@38.60.109.178:18804#233boy-ss-38.60.109.178
```

# Project Overview
这是一个 sing-box 管理脚本项目，提供便捷的 sing-box 配置管理功能。项目位于 `/Users/yxf/code/sing-box`，已有完整的脚本系统用于管理各种协议配置。

---
*以下部分由 AI 在协议执行过程中维护*
---

# Analysis (Populated by RESEARCH mode)

## SS URL 格式分析
从用户提供的示例和项目代码分析，SS URL 格式为：
```
ss://base64_encoded_part@server:port#tag
```

其中 base64_encoded_part 解码后格式为：
```
method:password
```

示例解析：
- `YWVzLTEyOC1nY206d296aGlhaTA=` 解码为 `aes-128-gcm:wozhiai0`
- 服务器地址：`38.60.109.178`
- 端口：`18804`
- 标签：`233boy-ss-38.60.109.178`

## sing-box Shadowsocks Outbound 格式
根据 `src/core.sh` 中的代码分析，sing-box shadowsocks outbound 的 JSON 格式为：
```json
{
  "tag": "config_name",
  "type": "shadowsocks",
  "server": "server_address",
  "server_port": port_number,
  "method": "encryption_method",
  "password": "password"
}
```

## 项目现有结构
- 主脚本：`sing-box.sh`
- 核心功能：`src/core.sh`
- 工具脚本位于 `src/` 目录
- 支持的 SS 加密方法列表已定义在 `ss_method_list` 中
- 现有 SS URL 生成逻辑在 `info()` 函数中（1316行）

## 技术要求
1. Base64 解码（需要处理 URL-safe base64）
2. URL 解析（提取服务器、端口、标签）
3. JSON 生成
4. 错误处理和验证

# Proposed Solution (Populated by INNOVATE mode)

## 方案分析

### 方案一：独立转换脚本 ⭐ (推荐)
创建独立的 `ss-to-singbox.sh` 脚本：
- **优点**：简单直接，易于维护，可独立使用，快速实现
- **缺点**：与现有系统集成度较低  
- **适用场景**：快速转换需求，工具化使用

### 方案二：集成到现有系统
将功能集成到 `sing-box.sh` 中：
- **优点**：充分利用现有基础设施，风格一致
- **缺点**：修改范围大，需要深入了解现有代码
- **适用场景**：长期维护的正式功能

### 方案三：混合方案
独立脚本但遵循项目规范：
- **优点**：平衡独立性和一致性
- **缺点**：需要额外维护一致性
- **适用场景**：未来可能集成的过渡方案

## 选定方案：独立脚本方案

### 核心功能设计
1. **输入处理**
   - 单个 SS URL 转换
   - 批量处理（文件/管道输入）
   - 订阅链接下载和处理

2. **输出格式**
   - 标准 sing-box outbound JSON
   - 可选择包装为完整配置
   - 支持美化和压缩输出

3. **错误处理**
   - URL 格式验证
   - Base64 解码验证  
   - 加密方法支持检查
   - 详细错误信息

4. **额外特性**
   - 自动标签生成
   - 去重处理
   - 配置验证
   - 连接测试（可选）

### 技术实现方向
- 使用 bash/shell 脚本
- 模块化函数设计
- 依赖系统工具（base64, jq, curl）
- 遵循 UNIX 工具链设计原则

# Implementation Plan (Generated by PLAN mode)

## 脚本架构设计

### 文件结构
- 主脚本：`ss-to-singbox.sh`
- 位置：项目根目录

### 核心函数模块

#### 1. 工具函数模块
```bash
error_exit()            # 错误退出处理
warn()                  # 警告信息输出
info()                  # 信息输出
debug()                 # 调试信息输出
trim()                  # 字符串去空白
check_dependencies()    # 检查系统依赖
```

#### 2. SS URL 解析模块
```bash
validate_ss_url()       # 验证 SS URL 格式
parse_ss_url()          # 解析 SS URL 各部分
decode_ss_credentials() # 解码 base64 认证信息
extract_method_password() # 分离加密方法和密码
```

#### 3. JSON 生成模块
```bash
generate_outbound_json() # 生成 sing-box outbound JSON
format_json_output()    # 格式化 JSON 输出
validate_json()         # 验证生成的 JSON
```

#### 4. 验证模块
```bash
validate_method()       # 验证加密方法支持
validate_server()       # 验证服务器地址格式
validate_port()         # 验证端口范围
```

#### 5. 批处理模块
```bash
process_subscription()  # 处理订阅链接
process_file()          # 处理文件输入
process_stdin()         # 处理标准输入
deduplicate_configs()   # 去重处理
```

## 核心算法设计

### SS URL 解析流程
1. 验证 `ss://` 前缀
2. 提取 base64 编码部分和服务器信息
3. 提取标签（# 后的内容）
4. Base64 解码获取 `method:password`
5. 解析服务器地址和端口
6. 构建配置对象

### JSON 生成流程
1. 创建 outbound 基础结构
2. 设置 type 为 "shadowsocks"
3. 填充服务器配置参数
4. 生成唯一标签名
5. 验证并格式化输出

## 命令行接口

### 基本用法
```bash
./ss-to-singbox.sh "ss://..."
./ss-to-singbox.sh -f urls.txt
cat urls.txt | ./ss-to-singbox.sh
```

### 选项参数
```bash
-f, --file FILE         从文件读取 SS URL
-o, --output FILE       输出到文件
-u, --subscription URL  处理订阅链接
-w, --wrap             包装为完整 sing-box 配置
-p, --pretty           美化 JSON 输出
-c, --compact          压缩 JSON 输出
-t, --test             测试连接（可选）
-v, --verbose          详细输出
-d, --debug            调试模式
-h, --help             显示帮助信息
```

## 错误处理策略
1. **输入验证错误**：URL 格式、参数缺失
2. **解析错误**：Base64 解码失败、格式错误
3. **配置错误**：不支持的加密方法、无效地址
4. **系统错误**：依赖缺失、权限不足
5. **网络错误**：订阅下载失败、连接超时

## Implementation Checklist:

1. **创建脚本框架和基础函数**
   - 设置 shebang、版本信息和基本变量
   - 实现错误处理函数 (error_exit, warn, info, debug)
   - 实现依赖检查函数 (check_dependencies)
   - 实现字符串处理工具函数

2. **实现 SS URL 解析核心逻辑**
   - 实现 URL 格式验证函数 (validate_ss_url)
   - 实现 URL 解析函数 (parse_ss_url)
   - 实现 Base64 解码函数 (decode_ss_credentials)
   - 实现加密方法和密码分离函数

3. **实现 JSON 生成功能**
   - 实现 outbound JSON 生成函数
   - 实现 JSON 格式化和验证
   - 添加标签生成逻辑
   - 支持完整配置包装选项

4. **实现命令行参数处理**
   - 使用 getopts 实现参数解析
   - 实现帮助信息显示函数
   - 处理不同输入源（命令行、文件、管道）
   - 实现输出重定向功能

5. **实现批处理和高级功能**
   - 实现文件批量处理
   - 实现订阅链接下载和解析
   - 添加配置去重功能
   - 实现连接测试功能（可选）

6. **添加验证和错误处理**
   - 实现加密方法支持检查
   - 添加服务器地址和端口验证
   - 完善错误信息和用户提示
   - 添加调试输出功能

7. **测试和优化**
   - 使用用户示例进行功能测试
   - 测试各种边界情况和错误场景
   - 优化性能和用户体验
   - 添加使用示例和文档

8. **最终验证和交付**
   - 完整功能测试
   - 代码审查和优化
   - 生成使用文档
   - 确保与用户需求匹配

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> 当前执行: "核心功能已完成，脚本可以正常使用"

# Task Progress (Appended by EXECUTE mode after each step completion)

**[2024-12-28]**
- **步骤**: 1. 创建脚本框架和基础函数
- **修改**: 创建了 `ss-to-singbox.sh` 脚本，包含错误处理、日志输出、依赖检查等基础函数
- **变更摘要**: 建立了完整的脚本框架，设置了全局变量和基础工具函数
- **原因**: 执行计划步骤 1
- **阻塞**: 无
- **用户确认状态**: 成功

**[2024-12-28]**
- **步骤**: 2. 实现 SS URL 解析核心逻辑  
- **修改**: 实现了 validate_ss_url, parse_ss_url, decode_ss_credentials, extract_method_password 等核心解析函数
- **变更摘要**: 成功解析用户示例 SS URL，提取出加密方法(aes-128-gcm)、密码(wozhiai0)、服务器(38.60.109.178)、端口(18804)和标签
- **原因**: 执行计划步骤 2，兼容 bash 3.2 环境
- **阻塞**: 无
- **用户确认状态**: 成功

**[2024-12-28]**
- **步骤**: 3. 实现 JSON 生成功能
- **修改**: 实现了 generate_outbound_json, generate_full_config, format_json_output, validate_json, process_single_ss_url 等函数
- **变更摘要**: 成功生成标准 sing-box outbound JSON 格式，支持美化输出、压缩输出和完整配置包装
- **原因**: 执行计划步骤 3，完成核心转换功能
- **阻塞**: 无
- **用户确认状态**: 成功

**[2024-12-28]**
- **步骤**: 4. 实现命令行参数处理
- **修改**: 完善了主函数的参数解析逻辑，支持所有计划的命令行选项
- **变更摘要**: 支持 -p(美化)、-c(压缩)、-w(完整配置)、-o(输出文件)、-v(详细)、-d(调试)、-h(帮助)等选项
- **原因**: 执行计划步骤 4，完成用户界面
- **阻塞**: 无
- **用户确认状态**: 成功

## 当前实现状态

### ✅ 已完成功能
1. **SS URL 解析**: 完全支持标准 SS URL 格式解析
2. **JSON 生成**: 生成标准 sing-box outbound JSON 格式
3. **输出格式**: 支持美化、压缩、完整配置包装
4. **命令行界面**: 完整的参数处理和帮助系统
5. **错误处理**: 完善的错误验证和用户提示
6. **兼容性**: 兼容 bash 3.2 环境

### 🔄 待实现功能（可选）
1. **文件批量处理**: 从文件读取多个 SS URL
2. **订阅链接处理**: 下载和处理订阅链接
3. **管道输入**: 从标准输入读取 URL
4. **连接测试**: 验证生成配置的连接性
5. **去重功能**: 处理重复配置

### 📋 核心功能测试结果
- ✅ 用户示例 SS URL 解析成功
- ✅ JSON 生成格式正确
- ✅ 命令行参数工作正常
- ✅ 输出到文件功能正常
- ✅ 帮助信息显示完整

# Final Review (Populated by REVIEW mode) 