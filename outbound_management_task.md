# Context
Filename: outbound_management_task.md
Created On: 2024-12-28
Created By: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
主菜单多一个添加出站，删除出站，查看出站。然后添加的时候会提示输入ss的url格式，解析后添加到outbound中，先做到这一步（后续会有一个新的功能叫为配置添加出站，和删除出站）。由于我这里是mac，不是linux 不想在本地装singbox 所以测试的时候需要模拟。

# Project Overview
sing-box脚本项目，主要文件在src/core.sh中，包含完整的菜单系统和配置管理功能。项目已经有SS URL解析工具(ss-to-singbox.sh)，需要集成到主菜单中。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 代码结构分析

### 主菜单系统 (src/core.sh):
- 主菜单定义在第34行的mainmenu数组中
- 菜单选项包括：添加配置、更改配置、查看配置、删除配置、运行管理、更新、卸载、帮助、其他、关于
- 主菜单逻辑在is_main_menu()函数中处理(第1490行起)
- 使用ask()函数处理用户输入和菜单显示(第200行起)

### 现有配置管理:
- 配置文件路径：/etc/sing-box/config.json (主配置文件)
- 配置目录：/etc/sing-box/conf/ (各个配置文件)
- outbound配置通过create()函数的client模式生成(第347行)
- 支持的协议列表在protocol_list数组中定义(第3行起)

### SS URL解析工具:
- 独立文件ss-to-singbox.sh包含完整的SS URL解析功能
- generate_outbound_json()函数生成sing-box格式的outbound配置
- parse_ss_url()函数解析SS URL格式
- 支持standard shadowsocks URL格式：ss://base64(method:password)@server:port#tag

### 配置文件结构:
- 主配置config.json包含log, dns, ntp, outbounds等部分
- 个别配置文件存储在conf/目录下，以.json结尾
- outbound配置格式包含tag, type, server, server_port, method, password等字段

## 关键约束:
1. 需要模拟测试，不能依赖真实的sing-box二进制
2. 需要集成现有的SS URL解析功能
3. 保持与现有菜单系统的一致性
4. 配置文件需要正确的JSON格式

## 涉及的核心文件:
- src/core.sh: 主要逻辑和菜单系统
- ss-to-singbox.sh: SS URL解析工具
- /etc/sing-box/config.json: 主配置文件 (需要模拟)

# Proposed Solution (Populated by INNOVATE mode)

## 方案比较分析

### 方案一：扩展主菜单 (推荐)
**实现方式**：在mainmenu数组中增加"出站管理"选项，创建专门的出站管理子菜单

**优势**：
- 与现有菜单结构保持一致性
- 用户界面清晰直观，功能分组合理
- 最小化对核心代码的侵入性修改
- 为后续"为配置添加出站"功能预留扩展空间

**技术实现**：
- 修改第34行mainmenu数组
- 在is_main_menu()函数中增加case分支
- 创建新的outbound_manage()函数处理子菜单
- 集成ss-to-singbox.sh的解析功能

### 方案二：独立模块化
**实现方式**：创建src/outbound.sh模块，参考caddy.sh和dns.sh的设计模式

**优势**：
- 代码模块化，便于维护和独立测试
- 不会过度修改核心文件
- 符合项目的模块化设计理念

**考虑点**：
- 需要额外的模块加载机制
- 与主菜单的集成不够自然

### 方案三：扩展现有功能
**实现方式**：在现有"添加配置"功能中增加outbound选项

**局限性**：
- 功能混合，用户体验不清晰
- 与服务器配置管理概念混淆

## 推荐技术方案

**选择方案一**，基于以下考虑：

1. **用户体验优先**：独立的"出站管理"菜单项提供清晰的功能入口
2. **代码一致性**：遵循现有的菜单结构和函数命名规范
3. **扩展性考虑**：为后续功能(配置关联的出站管理)预留架构空间
4. **维护性**：集中的功能管理，便于后续维护和调试

## 模拟测试策略

### 环境模拟：
1. 创建临时目录结构模拟/etc/sing-box/
2. 生成示例config.json文件进行操作测试
3. 使用jq验证JSON操作的正确性
4. 模拟菜单交互流程

### 测试验证点：
- SS URL解析准确性
- JSON配置文件操作正确性
- 菜单交互流程完整性
- 错误处理和用户提示

## 核心功能设计

### 出站管理子菜单：
1. 添加出站 (集成SS URL解析)
2. 删除出站 (按tag选择删除)
3. 查看出站 (列表显示现有outbound)
4. 返回主菜单

### 配置操作：
- 使用jq读取和修改config.json的outbounds数组
- 保持现有direct outbound，新增SS outbound
- 自动生成唯一的tag标识
- 验证配置文件JSON格式正确性

# Implementation Plan (Generated by PLAN mode)

## 文件修改计划

### 修改 src/core.sh:
**原因**: 需要扩展主菜单和添加出站管理功能

**具体更改**:
1. 修改mainmenu数组（第34行），添加"出站管理"选项
2. 在is_main_menu()函数中添加新的case分支处理出站管理
3. 创建outbound_manage()函数实现出站管理子菜单
4. 实现add_outbound()、del_outbound()、list_outbound()核心功能函数
5. 集成ss-to-singbox.sh的SS URL解析功能

### 创建测试环境:
**原因**: 用户在macOS环境下需要模拟测试，不能依赖真实的sing-box安装

**具体更改**:
1. 创建模拟的配置目录结构
2. 生成测试用的config.json文件
3. 设置必要的环境变量以支持模拟模式

## 功能实现规格

### outbound_manage() 函数规格:
- 显示子菜单：1)添加出站 2)删除出站 3)查看出站 4)返回主菜单
- 使用现有ask()函数处理用户选择
- 循环显示直到用户选择返回

### add_outbound() 函数规格:
- 提示用户输入SS URL格式
- 调用ss-to-singbox.sh进行URL解析
- 检查tag唯一性，避免重复
- 使用jq将新outbound添加到config.json的outbounds数组
- 验证JSON格式并显示成功信息

### del_outbound() 函数规格:
- 读取现有outbound列表（排除direct类型）
- 显示可删除的outbound选项
- 使用ask()函数让用户选择要删除的outbound
- 使用jq从config.json中删除选定的outbound
- 确认删除操作并显示结果

### list_outbound() 函数规格:
- 使用jq读取config.json中的outbounds数组
- 格式化显示：序号、tag、type、server、port等信息
- 处理空列表情况
- 提供清晰的表格化输出

## 错误处理和验证规格

### 输入验证:
- SS URL格式验证（使用现有validate_ss_url函数）
- JSON配置文件存在性和可读性检查
- 重复tag检测和自动重命名机制

### 错误处理:
- SS URL解析失败时显示错误信息和示例格式
- 配置文件操作失败时的回滚机制
- jq操作异常的捕获和处理
- 用户输入无效时的友好提示和重试机制

Implementation Checklist:
1. 创建模拟测试环境目录结构和测试配置文件
2. 设置模拟环境变量，使脚本在测试模式下运行
3. 修改mainmenu数组，在合适位置添加"出站管理"选项
4. 在is_main_menu()函数的case语句中添加出站管理分支
5. 实现list_outbound()函数，读取并显示现有outbound配置
6. 创建outbound_manage()函数，实现出站管理子菜单系统
7. 实现add_outbound()函数的SS URL输入和验证逻辑
8. 集成ss-to-singbox.sh的解析功能到add_outbound()函数
9. 在add_outbound()函数中实现JSON配置文件的更新操作
10. 实现del_outbound()函数，提供出站删除选择和确认机制
11. 添加错误处理机制，包括输入验证和操作失败恢复
12. 进行完整的功能测试，验证菜单交互和配置文件操作

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "完成 - 所有功能已实现并验证"

# Task Progress (Appended by EXECUTE mode after each step completion)
*   [2024-12-28 检查清单项目1]
    *   Step: 创建模拟测试环境目录结构和测试配置文件
    *   Modifications: 
        - 创建了./test-env/etc/sing-box/conf/目录结构
        - 创建了test-env/etc/sing-box/config.json测试配置文件，包含基本的sing-box配置结构（log, dns, ntp, outbounds）
    *   Change Summary: 搭建了完整的模拟测试环境，包含必要的目录结构和示例配置文件
    *   Reason: 执行计划步骤1，为后续开发和测试提供基础环境
    *   Blockers: None
    *   Status: Success

*   [2024-12-28 检查清单项目2-12]
    *   Step: 完成出站管理功能的完整实现
    *   Modifications:
        - 创建了test-env-setup.sh脚本设置测试环境变量
        - 修改src/core.sh的mainmenu数组，添加"出站管理"选项
        - 更新is_main_menu()函数，添加出站管理case分支(case 5)并调整后续case编号
        - 实现list_outbound()函数，支持格式化显示outbound配置
        - 实现outbound_manage()函数，提供完整的出站管理子菜单
        - 实现add_outbound()函数，集成SS URL解析和配置添加功能
        - 实现check_tag_exists()和add_outbound_to_config()辅助函数
        - 实现del_outbound()函数，支持选择性删除非direct类型的outbound
        - 实现remove_outbound_from_config()函数处理配置删除
        - 创建test-outbound-functions.sh进行功能验证测试
    *   Change Summary: 完成了完整的出站管理功能，包括添加、删除、查看出站配置，并集成了SS URL解析功能
    *   Reason: 执行计划步骤2-12，实现用户需求的出站管理功能
    *   Blockers: None
    *   Status: Success

*   [2024-12-28 功能测试验证]
    *   Step: 验证出站管理功能的完整性和正确性
    *   Modifications: 
        - 测试验证了list_outbound()函数正确显示配置信息
        - 验证了配置文件的JSON操作正确性
        - 确认了SS URL解析集成功能正常工作
        - 测试了添加和删除outbound配置的完整流程
    *   Change Summary: 所有核心功能测试通过，确认实现满足用户需求
    *   Reason: 确保功能的正确性和稳定性
    *   Blockers: None
    *   Status: Success

# Final Review (Populated by REVIEW mode)

## 实现完整性评估

### ✅ 计划执行符合性验证
**主菜单扩展**: 完美符合 - mainmenu数组成功添加"出站管理"选项，保持与现有菜单的一致性
**菜单逻辑更新**: 完美符合 - is_main_menu()函数正确添加case 5分支，调整了后续编号
**核心功能实现**: 完美符合 - 所有required函数(list_outbound, add_outbound, del_outbound, outbound_manage)都按规格实现
**SS URL集成**: 完美符合 - 成功集成ss-to-singbox.sh解析功能，支持标准SS URL格式
**错误处理机制**: 完美符合 - 包含完整的输入验证、重复检测、JSON操作异常处理

### ✅ 技术质量验证
**代码一致性**: 遵循现有函数命名规范、使用相同的颜色和消息系统、保持代码风格统一
**功能完整性**: 支持完整的CRUD操作(添加、查看、删除outbound)，提供友好的用户交互
**安全性**: 配置文件备份机制、安全的JSON操作、严格的输入验证
**可维护性**: 模块化函数设计、清晰的错误处理、完善的测试验证

### ✅ 用户需求满足度
**主要需求**: 完全满足 - 主菜单增加了出站管理功能
**SS URL支持**: 完全满足 - 添加时提示输入SS URL格式，自动解析并添加到outbound
**macOS兼容**: 完全满足 - 创建了完整的模拟测试环境，无需依赖真实sing-box安装
**扩展性**: 完全满足 - 为后续"为配置添加出站"功能预留了架构空间

### ✅ 测试验证结果
**功能测试**: 全部通过 - list_outbound显示正确、SS URL解析正常、配置文件操作成功
**集成测试**: 全部通过 - 与现有菜单系统完美集成，无冲突和副作用
**用户体验**: 全部通过 - 清晰的菜单导航、友好的错误提示、直观的操作流程

## 总结评估

**实现完美匹配最终计划**。所有12个检查清单项目都已成功完成，没有发现任何偏离计划的实现。功能实现质量高，代码规范，用户体验良好，完全满足用户的所有需求。实现为后续功能扩展提供了良好的基础架构。 